name: Auto Deployment to DockerHub & AWS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  backend:
    name: backend_build
    runs-on: ubuntu-latest
    env: 
      working-directory: |
          ./backend
          ./nginx

    strategy:
      matrix:
        node-version: [ 14.x ]

    steps:
    - name: after_success
      run: |
           docker build -t brinst07/docker-backend ./backend

    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

    - name: build and release to DockerHub
      env:
        NAME: brinst07
        REPO: github_action_test
      run: |
        docker push brinst07/docker-frontend
        docker push brinst07/docker-backend
        docker push brinst07/docker-nginx
      working-directory: ${{env.working-directory}}  

  frontend:
    name: frontend_build
    runs-on: ubuntu-latest
    env:
      working-directory: ./frontend
      
    strategy:
      matrix:
        node-version: [ 14.x ]
    
    steps:
    - name: before_install
      run: docker build -t brinst07/react-test-app -f ../frontend/Dockerfile.dev ./frontend

    - name: script
      run: docker run -e CI=true brinst07/react-test-app npm test
    
    
    - name: after_success
      run: |
           docker build -t brinst07/docker-frontend ./frontend
